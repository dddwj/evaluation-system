{% extends "evaluate/admin.html" %}
{% block content %}
    {{ block.super }}
    <button id="logTraining" class="btn btn-primary">查看训练情况</button>
    <button id="endTraining" class="btn btn-warning">结束训练</button>
    <hr>

    <div id="progress" style="display: none;">
        <div class="alert alert-info" id="progress-alert">
            <strong>正在训练！</strong>请耐心等待。
        </div>
        <div class="progress" style="height: 40px;" id="progress-bar">
            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width:100%; height: 100%;"></div>
        </div>
    </div>
    <div id="trainResult" class="alert" style="display: none;">
        <strong>成功！</strong>
    </div>


    <form id="paramsForm" class="form-horizontal" onsubmit="return false;">
        <label for="objective">模型</label>
        <select id="objective">
            <option selected>regression</option>
            <option>regression_l1</option>
            <option>huber</option>
            <option>fair</option>
            <option>poisson</option>
            <option>gammma</option>
            <option>binary</option>
        </select>
        <label for="metric">metric</label>
        <input type="text" id="metric" value="mse">
        <label for="learning_rate">learning rate</label>
        <input type="text" id="learning_rate" value="0.2">
        <label for="feature_fraction">feature_fraction</label>
        <input type="text" id="feature_fraction" value="0.6">
        <label for="bagging_fraction">bagging_fraction</label>
        <input type="text" id="bagging_fraction" value="0.6">
        <label for="max_depth">max_depth</label>
        <input type="text" id="max_depth" value="14">
        <label for="num_leaves">num_leaves</label>
        <input type="text" id="num_leaves" value="220">
        <label for="bagging_freq">bagging_freq</label>
        <input type="text" id="bagging_freq" value="5">
        <label for="min_data_in_leaf">min_data_in_leaf</label>
        <input type="text" id="min_data_in_leaf" value="10">
        <label for="min_gain_to_split">min_gain_to_spilt</label>
        <input type="text" id="min_gain_to_split" value="0">
        <label for="lambda_l1">L1</label>
        <input type="text" id="lambda_l1" value="1">
        <label for="lambda_l2">L2</label>
        <input type="text" id="lambda_l2" value="1">
        <label for="verbose">verbose</label>
        <input type="text" id="verbose" value="0">
        <label for="comment">comment</label>
        <input type="text" id="comment" value="新加的模型">

        <input type="submit" id="startTrainingBtn" class="btn btn-primary" value="开始训练"/>
        <input type="button" id="setParamsBtn" class="btn btn-primary" value="修改参数">
        <input type="button" id="confirmParamsBtn" class="btn btn-primary" value="锁定参数">
    </form>

    <hr>


    <form id="chooseModelForm" onsubmit="return false;">
        <select id="modelListSelectF">
        </select>
        <button id="chooseModelBtn" class="btn btn-primary">选择用户端模型</button>
    </form>
    <label for="currentModel">当前选择的模型</label><div id="currentModelDiv">123</div>


    <script type="text/javascript">

        $('#setParamsBtn').click(function () {
            $('#paramsForm').children("input").removeAttr("readonly");
        });
        $('#confirmParamsBtn').click(function () {
            $('#paramsForm').children("input").attr("readonly","readonly");
        });
        $('#confirmParamsBtn').click();

        var months = {
            startMonth: $("#startMonth").val(),
            endMonth: $("#endMonth").val()
        };

        $("#startTrainingBtn").click( function () {
            var params = {
                startMonth: $("#startMonth").val(),
                endMonth: $("#endMonth").val(),
                objective: $('#objective').val(),
                metric: $('#metric').val(),
                learning_rate: $('#learning_rate').val(),
                feature_fraction: $('#feature_fraction').val(),
                bagging_fraction: $('#bagging_fraction').val(),
                max_depth: $('#max_depth').val(),
                num_leaves: $('#num_leaves').val(),
                bagging_freq: $('#bagging_freq').val(),
                min_data_in_leaf: $('#min_data_in_leaf').val(),
                min_gain_to_split: $('#min_gain_to_split').val(),
                lambda_l1: $('#lambda_l1').val(),
                lambda_l2: $('#lambda_l2').val(),
                verbose: $('#verbose').val(),
                comment: $('#comment').val()
            };
            $("#progress").show();
            $.ajax({
                type: "GET",
                url: "api/model/startTraining",
                data: params,
                async: true,
                error: function (request) {
                    console.log(request);
                    $("#progress").hide();
                    $("#trainResult").addClass("alert-warning");
                    $("#trainResult").html("<strong>训练失败！</strong>");
                    $("#trainResult").show();
                },
                success: function (response) {
                    console.log(response);
                    $("#trainResult").addClass("alert-success");
                    $("#trainResult").html("<strong>训练成功！</strong> 模型编号：" + response.model_id);
                    $("#trainResult").show();
                    getModelList();
                    $("#progress").hide();
                }
            });
        });

        function getModelList(){
            $.ajax({
                type: "GET",
                url: "api/model/modelList",
                data: null,
                async: false,
                error: function (request) {
                    console.log(request);
                    alert("获取模型列表失败");
                },
                success: function (response) {
                    var modelList =response.modelList;
                    $("#modelListSelectF").children().remove();
                    $("#modelListSelectF").prepend("<option value='0'>请选择id</option>");
                    for (var i = 0; i < modelList.length; i++ ){
                        $("#modelListSelectF").append("<option value='" + modelList[i].id + "'>" + modelList[i].comment + "</option>")
                    }
                }
            });
        }

        function getCurrentModel(){
            $.ajax({
                type: "GET",
                url: "api/model/getCurrentModel",
                data: null,
                error: function (request) {
                    console.log(request);
                },
                success: function (response) {
                    console.log(response.model);
                    $("#currentModelDiv").html(JSON.stringify(response.model));
                }
            })
        }

        $(document).ready(function () {
            getModelList();
            getCurrentModel();
        });

        $("#chooseModelBtn").click(function () {
            $.ajax({
                type: "GET",
                url: "api/model/chooseModel",
                data: {
                    model_id: $("#modelListSelectF").val(),
                },
                error: function (request) {
                    console.log(request);
                    alert("选择失败！");
                },
                success: function (response) {
                    console.log(response);
                    alert("选择成功！");
                    getCurrentModel();
                }

            })
        });


    </script>


    {% block  field %}


    {% endblock %}
{% endblock %}